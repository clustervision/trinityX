---
- hosts: controllers

  # List of roles to apply to the controllers, in the order in which they will run.
  # NOTE: These and their default configurations can be found in the "roles/"
  #       directory.

  roles:
    - role: trinity/prepare
      tags:
        - init
        - always

    - role: trinity/init
      tags: 
        - init
        - authentication

    - role: trinity/hostname
      tags: hostname

    - role: trinity/no_proxy
      no_proxy:
        - ".{{ trix_domain }}"
        - "{{ trix_ctrl_ip }}"
        - "{{ trix_external_fqdn }}"
      tags: noproxy

    - role: trinity/repos
      tags: repos

    - role: trinity/packages
      tags: packages

    - role: OndrejHome.pcs-modules-2
      tags: ha,pcs,pacemaker,shared-fs

    - role: trinity/sync-secrets
      tags: ha,sync-secrets
      when: ha | default(False)

    - role: trinity/pacemaker
      fence_ipmilan_enabled: '{{ enable_ipmilan_fencing | default(True) }}'
      tags: ha,pcs,pacemaker
      when: ha | default(False)

    - role: trinity/shared-fs
      drbd_shared_resource_stonith_enabled: '{{ enable_ipmilan_fencing | default(True) }}'
      tags: ha,shared-fs
      when: ha | default(False)

    - role: trinity/nfs-mounts
      nfs_remote_mask: '{{ shared_fs_disks }}'
      nfs_mounts: []
      tags: shared-fs,nfs-mounts

    - role: trinity/trix-tree
      tags: 
        - trix-tree
        - authentication

    - role: trinity/cv_support
      tags: cv_support

    # - role: trinity/sensu-client
    #   tags: monitoring

    - role: trinity/tunables
      tags: tunables

    - role: trinity/firewalld
      tags: firewalld

    - role: trinity/chrony
      tags: chrony

    - role: trinity/rdma-centos
      tags: rdma-centos

    - role: trinity/ssh
      tags: ssh

    # -----
    # - role: trinity/fail2ban
    #   tags: fail2ban
    # -----

    - role: trinity/nfs
      nfs_rpccount: 256
      nfs_enable_rdma: false
      nfs_export_shared: true
      nfs_export_home: true
      nfs_exports_path: '{{ trix_local }}/etc/exports.d'
      nfs_mounts:
        - path: '/trinity/shared'
          remote: '{{ trix_ctrl_hostname }}:/trinity/shared'
          options: 'defaults,nfsvers=4,ro,retrans=4'
      tags: nfs

    - role: trinity/ssl-cert
      ssl_cert_country: 'NL'
      ssl_cert_locality: 'Amsterdam'
      ssl_cert_organization: 'ClusterVision Solutions B.V.'
      ssl_cert_state: 'Noord Holland'
      ssl_cert_altname: 
        - '{{ trix_ctrl_hostname }}.{{ trix_domain }}'
        - '{{ ansible_fqdn }}'
        - '{{ trix_external_fqdn }}'
      ssl_cert_altip: 
        - '{{ all_ctrl_ip }}'
      ssl_cert_days: '36500'
      tags: 
        - ssl-cert
        - authentication  

    - role: trinity/bind
      bind_db_path: '{{ trix_local }}/var/lib/named'
      bind_dnssec_enable: "no"
      bind_dns_forwarders: '{{ trix_dns_forwarders }}'
      tags: bind

    - role: trinity/openldap
      openldap_server_dir_path: "{{ trix_ha if ha else trix_local }}/var/lib/ldap"
      openldap_server_conf_path: "{{ trix_ha if ha else trix_local }}/etc/openldap/slapd.d"
      openldap_host: '{{ trix_ctrl_hostname }}.{{ trix_domain }}'
      when: enable_authentication|default(True)
      tags: 
        - openldap
        - authentication

    - role: trinity/obol
      users_home_path: '{{ trix_home }}'
      ldap_host: '{{ trix_ctrl_hostname }}.{{ trix_domain }}'
      when: enable_authentication|default(True)
      tags: 
        - obol
        - authentication

    - role: trinity/sssd
      sss_allowed_groups:
        - '{{ admin_group }}'
      sss_ldap_hosts:
        - '{{ trix_ctrl_hostname }}.{{ trix_domain }}'
      when: enable_authentication|default(True)
      tags: 
        - sssd
        - authentication

    - role: trinity/mariadb
      mariadb_db_path: "{{ trix_ha if ha else trix_local }}/var/lib/mysql"
      tags: mariadb

    - role: trinity/openhpc
      nfs_exports_path: '{{ trix_local }}/etc/exports.d'
      when: enable_openhpc
      tags: openhpc

    - role: trinity/slurm
      slurm_ctrl: '{{ trix_ctrl_hostname }}'
      slurm_ctrl_ip: '{{ trix_ctrl_ip }}'
      #slurm_ctrl_list: '{{ trix_ctrl1_hostname }},{{ trix_ctrl2_hostname }}'
      slurm_ctrl_list: '{{ all_ctrl_hostname | join(",") }}'
      slurm_conf_path: '{{ trix_shared }}/etc/slurm'
      #slurm_spool_path: '{{ trix_local }}/var/spool/slurm'
      slurm_spool_path: "{{ trix_ha if ha else trix_local }}/var/spool/slurm"
      munge_conf_path: '{{ trix_shared }}/etc/munge'
      slurmdbd_sql_user: 'slurm_accounting'
      slurmdbd_sql_db: 'slurm_accounting'
      when: workload_manager == "slurm"
      tags: slurm

    - role: trinity/slurm-sbank
      when: workload_manager == "slurm"
      tags: slurm, sbank

    - role: trinity/config-manager
      cm_admin_group: "{{ admin_group }}"
      tags: config-manager

    - role: trinity/luna2
      ssl_certificate: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.crt"
      ssl_certificate_key: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.key"
      luna2_cluster:
        ha: '{{ ha }}'
        frontend_address: '{{ trix_ctrl_ip }}'
        controllers: 
          hostnames: '{{ all_ctrl_hostname }}'
          ip_addresses: '{{ all_ctrl_ip }}'
        networks:
        - name: '{{ trix_domain }}'
          function: 'default'
          ip: '{{ trix_cluster_net }}'
          prefix: '{{ trix_cluster_netprefix }}'
          start_ip: '{{ trix_cluster_dhcp_start }}'
          end_ip: '{{ trix_cluster_dhcp_end }}'
          type: 'ethernet'
        - name: 'ipmi'
          function: 'bmc'
          ip: '10.148.0.0'
          prefix: '16'
          type: 'ethernet'
        - name: 'ib'
          function: 'low-latency'
          ip: '10.149.0.0'
          prefix: '16'
          type: 'infiniband'
      tags: luna

    - role: trinity/resolv
      bind_dns_forwarders: '{{ trix_dns_forwarders }}'
      resolv_server: '{{ trix_ctrl_ip }}'
      tags: resolv

    - role: trinity/rsyslog
      syslog_listeners:
        - name: default
          proto: tcp
          port: 514
        - name: default
          proto: udp
          port: 514
      syslog_file_template_rules:
        - name: controllers
          type: string
          content: '/var/log/cluster-messages/%HOSTNAME%.messages'
          field: '$fromhost-ip'
          criteria: startswith
          rule: '{{ trix_cluster_net.split(".")[:trix_cluster_netprefix//8]|join(".") }}'
      tags: rsyslog

    - role: trinity/logrotate
      tags: logrotate

    #  ----------
    # - role: trinity/docker-registry
    #   when: enable_docker
    #   docker_registry_path: '{{ trix_local }}/docker-registry'
    #   docker_ssl_path: '{{ ssl_cert_path }}'
    #   docker_ssl_cert: '{{ ansible_fqdn }}.crt'
    #   docker_ssl_key: '{{ ansible_fqdn }}.key'
    #   tags: docker-registry
    #  ------------

    - role: trinity/aria2c
      tags: aria2c

    - role: trinity/ood-portal
      enable_ssl: true
      ssl_certificate: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.crt"
      ssl_certificate_key: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.key"
      login_host: "{{ trix_external_fqdn }}"
      ldap_host: "{{ trix_ctrl_ip }}"
      ood_admin_group: "{{ admin_group }}"
      tags: ood

    - role: trinity/ood-vnc
      tags: ood

    # - role: trinity/telegraf
    #   tags: monitoring
    #   influxdb_server: "{{ trix_ctrl_ip }}"

    # - role: trinity/rabbitmq
    #   tags: monitoring

    # - role: trinity/sensu-server
    #   tags: monitoring

    # - role: trinity/influxdb
    #   tags: monitoring
    #   influxdb_server: "{{ trix_ctrl_ip }}"

    # - role: trinity/prometheus-auth
    #   prometheus_auth_credentials_file: '/etc/trinity/passwords/prometheus/admin.txt'
    #   tags: prometheus-auth, prometheus, monitoring

    - role: trinity/prometheus-server
      # Prometheus server
      prometheus_server_config_dir: "{{trix_etc}}/prometheus_server"
      prometheus_server_db_dir: "{{trix_local}}/var/lib/prometheus_server"
      prometheus_server_additional_system_groups:
        - "{{ssl_cert_group}}"
      prometheus_server_additional_sd:
        - job_name: luna_nodes
          http_sd_configs:
          - url: "{{ luna_protocol }}://localhost:7050/export/prometheus"
            tls_config:
              insecure_skip_verify: true
      prometheus_server_alertmanagers:
        - target: "localhost:9093"
          tls:
            enabled: true
            insecure_skip_verify: true
          basic_auth:
            enabled: true
            credentials_file: '/etc/trinity/passwords/prometheus/admin.txt'
      prometheus_server_tls:
        enabled: true
        cert_file: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.crt"
        key_file: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.key"
      tags: prometheus-server, prometheus, monitoring


    - role: trinity/prometheus-alertmanager
      # Prometheus alertmanager
      prometheus_alertmanager_config_dir: "{{trix_etc}}/prometheus_alertmanager"
      prometheus_alertmanager_db_dir: "{{trix_local}}/var/lib/prometheus_alertmanager"
      prometheus_alertmanager_mail: "{{ administrator_email }}"
      prometheus_alertmanager_additional_system_groups:
        - "{{ssl_cert_group}}"
      prometheus_alertmanager_cluster:
        listen-address: "{{ ansible_fqdn }}:6783"
        peers:
          - "{{ trix_ctrl_hostname }}:6783"
      prometheus_alertmanager_auth:
        enabled: true
        credentials_file: '/etc/trinity/passwords/prometheus/admin.txt'
      prometheus_alertmanager_tls:
        enabled: true
        cert_file: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.crt"
        key_file: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.key"
      tags: prometheus-alertmanager, prometheus, monitoring

    - role: trinity/prometheus-node-exporter
      # Prometheus node exporter
      prometheus_node_exporter_config_dir: "{{trix_etc}}/prometheus_node_exporter"
      prometheus_node_exporter_db_dir: "{{trix_local}}/var/lib/prometheus_node_exporter"
      prometheus_node_exporter_sd_file: "{{trix_etc}}/prometheus_server/file_sd/trix/controllers_node_exporter.yml"
      prometheus_node_exporter_targets: "{{ (all_ctrl_ip) | zip(all_ctrl_hostname, [trix_domain] * (num_ctrl | int)) }}"
      tags: prometheus-node-exporter, prometheus, monitoring

    - role: trinity/prometheus-slurm-exporter
      # Prometheus slurm exporter
      prometheus_slurm_exporter_system_user: root
      prometheus_slurm_exporter_sd_file: "{{trix_etc}}/prometheus_server/file_sd/trix/controllers_slurm_exporter.yml"
      prometheus_slurm_exporter_targets: "{{ (all_ctrl_ip) | zip(all_ctrl_hostname, [trix_domain] * (num_ctrl | int)) }}"
      tags: prometheus-slurm-exporter, prometheus, monitoring

    - role: trinity/prometheus-ipmi-exporter
      # Prometheus ipmi exporter
      prometheus_ipmi_exporter_system_user: root
      prometheus_ipmi_exporter_sd_file: "{{trix_etc}}/prometheus_server/file_sd/trix/controllers_ipmi_exporter.yml"
      prometheus_ipmi_exporter_targets: "{{ (all_ctrl_ip) | zip(all_ctrl_hostname, [trix_domain] * (num_ctrl | int)) }}"
      tags: prometheus-ipmi-exporter, prometheus, monitoring

    - role: trinity/prometheus-nvidia-exporter
      # Prometheus ipmi exporter
      prometheus_nvidia_exporter_system_user: root
      prometheus_nvidia_exporter_sd_file: "{{trix_etc}}/prometheus_server/file_sd/trix/controllers_nvidia_exporter.yml"
      prometheus_nvidia_exporter_targets: "{{ (all_ctrl_ip) | zip(all_ctrl_hostname, [trix_domain] * (num_ctrl | int)) }}"
      tags: prometheus-nvidia-exporter, prometheus, monitoring

    - role: trinity/prometheus-ha-exporter
      # Prometheus ipmi exporter
      prometheus_ha_exporter_system_user: root
      prometheus_ha_exporter_sd_file: "{{trix_etc}}/prometheus_server/file_sd/trix/controllers_ha_exporter.yml"
      prometheus_ha_exporter_targets: "{{ (all_ctrl_ip) | zip(all_ctrl_hostname, [trix_domain] * (num_ctrl | int)) }}"
      tags: prometheus-ha-exporter, prometheus, monitoring, ha
      when: ha | default(False)

    - role: trinity/grafana
      ldap_auth: "{{ enable_authentication|default(True) }}"
      enable_ssl: true
      grafana_admin_group: "{{ admin_group }}"
      grafana_prometheus_url: "https://{{ trix_ctrl_local_ip }}:9090"
      ssl_certificate: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.crt"
      ssl_certificate_key: "{{ ssl_cert_path }}/{{ ansible_fqdn }}.key"
      tags: grafana, monitoring

    - role: trinity/cleanup-legacy
      tags: cleanup-legacy

    - role: trinity/wrapup
      tags: wrapup

  environment:
    no_proxy: ".{{ trix_domain }},{{ trix_ctrl_ip }},{{ trix_external_fqdn }}"
    NO_PROXY: ".{{ trix_domain }},{{ trix_ctrl_ip }},{{ trix_external_fqdn }}"
