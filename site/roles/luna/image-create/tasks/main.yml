---
- name: Defining group name
  set_fact:
    luna_group_name: '{{ luna_image_name | regex_replace("^(.*)-image$", "\1-group") }}'
  when: luna_group_name is not defined


- name: Verify if image already exists in luna
  shell: "luna osimage show {{ luna_image_name }}"
  register: luna_image_in_luna
  ignore_errors: true

- name: Verify if group already exists in luna
  shell: "luna group show {{ luna_group_name }}"
  register: luna_image_in_luna
  ignore_errors: true


- name: Fetching the distribution version from the image
  shell: "cat {{ luna_image_path }}/etc/redhat-release | awk -F 'release ' '{ print $2 }' | awk -F '.' '{ print $1 }' | grep '^.\\+$' || echo {{ ansible_distribution_major_version }}"
  ignore_errors: true
  register: luna_image_major_version
  when: ansible_facts['os_family'] == "RedHat"

- name: Fetching the distribution version from the image
  shell: "grep DISTRIB_RELEASE {{ luna_image_path }}/etc/lsb-release | awk -F'=' '{ print $2 }' | awk -F '.' '{ print $1 }' | grep '^.\\+$' || echo '22'"
  ignore_errors: true
  register: luna_image_major_version
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- name: Fetching the distribution version from the image
  shell: "grep VERSION {{ luna_image_path }}/etc/SUSE-brand | awk -F' = ' '{ print $2 }' || echo {{ ansible_distribution_major_version }}"
  ignore_errors: true
  register: luna_image_major_version
  when: ansible_facts['os_family'] == "Suse" or ansible_facts['os_family'] == "SLE"


- name: Creating image in luna
  shell: "luna osimage add --path \"{{ luna_image_path }}\" --distribution {{ ansible_os_family|lower }} --osrelease {{ luna_image_major_version.stdout }} --quick-kerneloptions \"net.ifnames=0 biosdevname=0\" {{ luna_image_name }}"
  when: luna_image_in_luna is defined and luna_image_in_luna.rc|int != 0

- name: Setting release for image
  shell: "luna osimage change --distribution {{ ansible_os_family|lower }} --osrelease {{ luna_image_major_version.stdout }} {{ luna_image_name }}"
  when: luna_image_in_luna is defined and luna_image_in_luna.rc|int == 0


- name: Kernel version in image
  shell: "ls {{ luna_image_path }}/lib/modules|sort|tail -n1"
  register: kernel_version
  changed_when: false

- name: Set the kernel version for image
  ansible.builtin.shell:
    cmd: "luna osimage change --kernelversion {{ kernel_version.stdout }} {{ luna_image_name }}"
  when:
    - kernel_version is defined
    - kernel_version.rc|int == 0
    - kernel_version.stdout_lines|length > 0


- block:
  - set_fact:
      luna_image_distri: 'ubuntu'
    when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu' 

  - set_fact:
      luna_image_distri: 'opensuse'
    when: ansible_facts['os_family'] == "Suse" or ansible_facts['os_family'] == "SLE"

  - name: preparing part/post script
    copy:
      src: "{{ luna_image_distri }}/{{ item }}"
      dest: "/tmp/{{ item }}"
    with_items:
      - part.rd
      - post.rd

  - name: Creating group in luna
    shell: "luna group add --osimage {{ luna_image_name }} -qpart /tmp/part.rd -qpost /tmp/post.rd {{ luna_group_name }}"
    when: luna_image_distri is defined

  - name: Creating group in luna
    shell: "luna group add --osimage {{ luna_image_name }} {{ luna_group_name }}"
    when: luna_image_distri is not defined
  when: group_in_luna is defined and group_in_luna.rc|int != 0


- name: Refresh the list of hosts in the inventory
  meta: refresh_inventory
