- name: Create EB_TMPDIR directory
  file:
    path: "{{ easybuild_tmpdir }}"
    state: directory
    mode: '0755'

- name: Install EasyBuild via pip
  command: "{{ python_executable }} -m pip install --ignore-installed --prefix {{ easybuild_tmpdir }} easybuild"
  environment:
    EB_TMPDIR: "{{ easybuild_tmpdir }}"
  args:
    creates: "{{ easybuild_tmpdir }}/bin/eb"

- name: Set EB environment and install EasyBuild release
  shell: |
    source /etc/profile
    source /etc/profile.d/modules.sh || true
    export EB_TMPDIR="{{ easybuild_tmpdir }}"
    export PATH="$EB_TMPDIR/bin:$PATH"
    export PYTHONPATH="$(ls -rd -1 {{ easybuild_tmpdir }}/lib*/python*/site-packages | tail -1):$PYTHONPATH"
    export EB_PYTHON={{ python_executable }}
    export EB_HOME={{ easybuild_home }}
    eb --install-latest-eb-release --prefix $EB_HOME --skip-sanity-check
  environment:
    EB_TMPDIR: "{{ easybuild_tmpdir }}"
    EB_HOME: "{{ easybuild_home }}"
  args:
    executable: /bin/bash
