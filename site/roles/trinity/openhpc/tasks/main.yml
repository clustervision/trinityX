---

- block:
  - name: Create trinity/ohpc dir for opt link to point at
    file:
      path: "{{ trix_ohpc }}"
      owner: root
      group: root
      state: directory
      mode: '0755'

  - name: Create link so openhpc ends up on /trinity filesystem
    file:
      src: "{{ trix_ohpc }}"
      path: '{{ openhpc_home }}'
      owner: root
      group: root
      state: link
  when: on_controller

- block:
  - name: Detect openhpc structure
    stat:
      path: '{{ openhpc_home }}'
    register: openhpc_structure

  - name: Remove deprecated openhpc directory
    file:
      path: '{{ openhpc_home }}'
      state: absent
    when:
      - openhpc_structure.stat.islnk is defined
      - not openhpc_structure.stat.islnk

  - name: Create trinity/ohpc dir for opt link to point at
    file:
      path: '{{ trix_ohpc }}'
      owner: root
      group: root
      state: directory
      mode: '0755'

  - name: Create link so openhpc ends up on /trinity filesystem
    file:
      src: '{{ trix_ohpc }}'
      path: '{{ openhpc_home }}'
      owner: root
      group: root
      state: link

  - name: Remove deprecated mount path
    ansible.posix.mount:
      path: '{{ openhpc_home }}'
      state: absent_from_fstab
  when: in_image or in_login_image|default(False)

- name: Configure OpenHPC repos
  ansible.builtin.yum_repository:
    name: "openhpc-{{ item.name }}"
    description: "openhpc-{{ item.name }}"
    baseurl: "{{ item.repo }}"
    gpgcheck: "{{ item.gpgcheck | default(False) }}"
    gpgkey: "{{ item.gpgkey | default('') }}"
  with_items: "{{ lookup('ansible.builtin.vars', 'el' + ansible_distribution_major_version + '_openhpc_repositories') }}"

- name: Ensure conflicting rpms from legacy TrinityX are not installed
  yum:
    name:
      - pdsh
      - environment-modules
    state: removed
  retries: "{{ rpm_retries | default(3) }}"
  delay: "{{ rpm_delay | default(15) }}"

- name: Install ohpc-base
  yum:
    name: ohpc-base
    state: installed
    enablerepo: powertools
  when: on_controller
  retries: "{{ rpm_retries | default(3) }}"
  delay: "{{ rpm_delay | default(15) }}"

- name: Install ohpc-base-compute
  yum:
    name: ohpc-base-compute
    state: installed
  when: on_controller
  retries: "{{ rpm_retries | default(3) }}"
  delay: "{{ rpm_delay | default(15) }}"

- block:
  - name: Install pdsh-mod-genders-ohpc
    yum:
      name: pdsh-mod-genders-ohpc
      state: installed
    retries: "{{ rpm_retries | default(3) }}"
    delay: "{{ rpm_delay | default(15) }}"

  - name: Create empty pdsh genders file
    file:
      path: /etc/genders
      state: touch
  when: on_controller

- name: Install lmod dependencies on non-controller nodes
  yum:
    name:
      - lua-filesystem
      - lua-posix
    enablerepo: powertools
    state: installed
  when: in_image
  retries: "{{ rpm_retries | default(3) }}"
  delay: "{{ rpm_delay | default(15) }}"

- name: Create symlinks for pdsh and pdcp
  file:
    dest: "/usr/bin/{{ item }}"
    src: "{{ openhpc_home }}/admin/pdsh/bin/{{ item }}"
    state: link
    force: true
    follow: false
  with_items:
    - pdsh
    - pdcp

- name: Install lmod-ohpc
  yum:
    name: lmod-ohpc
    state: installed
    enablerepo: powertools
  retries: "{{ rpm_retries | default(3) }}"
  delay: "{{ rpm_delay | default(15) }}"

- name: Install profile for modules
  template:
    src: z_trinityx.sh.j2
    dest: /etc/profile.d/z_trinityx.sh

- name: Update NFS exports
  template:
    src: OHPC_exports.j2
    dest: '{{ nfs_exports_path }}/ohpc.exports'
  when: on_controller
  notify:
    - Export NFS

- file:
    src: '{{ nfs_exports_path }}/ohpc.exports'
    dest: '/etc/exports.d/ohpc.exports'
    state: link
    force: "yes"
  when: on_controller
  notify:
    - Export NFS
