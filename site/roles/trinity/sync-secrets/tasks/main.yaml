---

- block:

  - name: Load a variable file based on the OS type, or a default if not found. Using free-form to specify the file.
    include_vars: "{{ item }}"
    with_first_found:
      - "{{ ansible_distribution }}{{ ansible_distribution_major_version}}.yaml"
      - "{{ ansible_os_family }}{{ ansible_distribution_major_version}}.yaml"
    ignore_errors: true

  - name: Install required packages
    yum:
      name: "{{ sync_secrets_packages }}"
      state: present
      disable_gpg_check: true
    tags: install-only

  - name: Ensure temporary sync mount location exists
    file:
      path: /mnt/sync
      state: directory

  - name: Temporarily mount sync from controller1
    shell: "mount {{ trix_ctrl1_ip }}:{{ trix_sync }} /mnt/sync"

  - name: Copy all secrets
    copy:
      src: '/mnt/sync/'
      dest: '{{ trix_sync }}'

  - name: Umount sync
    shell: "umount -l /mnt/sync"
  when:
    - not primary

