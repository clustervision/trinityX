---
- name: Load a variable file based on the OS type, or a default if not found. Using free-form to specify the file.
  include_vars: "{{ package_arch }}/docker-{{ image_create_distribution }}.yaml"

- name: Create /dev
  file:
    path: "/dev/"
    state: directory
    mode: 0755
    owner: root
    group: root

- name: Create basic /dev files
  command: "/usr/bin/mknod /dev/{{ item.dev }} {{ item.t }} {{ item.ma }} {{ item.mi }} creates=/dev/{{ item.dev }}"
  args:
    creates: "/dev/{{ item.dev }}"
  with_items:
    - {dev: "null", mo: "666", t: 'c', ma: 1, mi: 3}  # device, mode, type, major, minor
    - {dev: "zero", mo: "666", t: 'c', ma: 1, mi: 5}
    - {dev: "random", mo: "666", t: 'c', ma: 1, mi: 8}
    - {dev: "urandom", mo: "666", t: 'c', ma: 1, mi: 9}
    - {dev: "console", mo: "600", t: 'c', ma: 5, mi: 1}
    - {dev: "ptmx", mo: "666", t: 'c', ma: 5, mi: 2}
    - {dev: "tty", mo: "666", t: 'c', ma: 5, mi: 0}

- name: Configuring resolv.conf
  copy:
    dest: "/etc/resolv.conf"
    content: "nameserver {{ trix_ctrl_ip }}"

- name: Configure TrinityX repos
  ansible.builtin.yum_repository:
    name: "{{ item.name }}"
    description: "{{ item.name }}"
    baseurl: "{{ item.repo }}"
    gpgcheck: "{{ item.gpgcheck | default(False) }}"
    gpgkey: "{{ 'file://' + item.gpgkey if item.gpgcheck else '' }}"
  with_items: "{{ trinityx_repositories }}"
  when: item.name is defined

- name: Rebuild RPM DB
  shell: "rpm --rebuilddb"
  ignore_errors: true

- name: Install core packages - @core, kernel and grub2
  ansible.builtin.dnf:
    name: "{{ item }}"
    state: present
  ignore_errors: true
  with_items: "{{ image_core_packages }}"
  retries: "{{ rpm_retries | default(3) }}"
  delay: "{{ rpm_delay | default(15) }}"

- name: Reinstall packages
  shell: "dnf -y reinstall {{ item }}"
  ignore_errors: true
  with_items: "{{ image_reinstall_packages }}"

- name: Remove clashing packages
  shell: "rpm -e --nodeps {{ item }}"
  ignore_errors: true
  with_items: "{{ image_remove_packages }}"

- name: Add dracut.conf.d entries
  template:
    src: trinity.conf.j2
    dest: "/etc/dracut.conf.d/trinity.conf"
