---
- name: Get osimage path
  set_fact:
    osimage_path: "{{  trix_images }}/{{ osimage_name }}"

- name: Create dir for compute osimage
  file:
    name: "{{ osimage_path }}"
    state: directory

- name: Install yum-utils
  yum:
    name: yum-utils
    state: present

- name: Init rpm DB {{ osimage_path }}/var/lib/rpm
  command: "/usr/bin/rpm --root {{ osimage_path }} --initdb"
  args:
    creates: "{{ osimage_path }}/var/lib/rpm"

- name: Install centos-release to {{ osimage_path }}
  shell: >
    /usr/bin/yumdownloader --destdir {{ osimage_path }} centos-release &&
    /usr/bin/rpm --root {{ osimage_path }} -ivh {{ osimage_path }}/centos-release-*.rpm &&
    /usr/bin/rm -rf {{ osimage_path }}/centos-release-*.rpm
  args:
    creates: "{{ osimage_path }}/etc/os-release"

- name: Create {{ osimage_path }}/dev
  file:
    path: "{{ osimage_path }}/dev/"
    state: directory
    mode: 0755
    owner: root
    group: root

- name: Create basic /dev files
  command: "/usr/bin/mknod {{ osimage_path }}/dev/{{ item.dev }} {{ item.t }} {{ item.ma }} {{ item.mi }} creates={{ osimage_path }}/dev/{{ item.dev }}"
  args:
    creates: "{{ osimage_path }}/dev/{{ item.dev }}"
  with_items:
    - { dev: "null",    mo: "666", t: 'c', ma: 1, mi: 3 } # device, mode, type, major, minor
    - { dev: "zero",    mo: "666", t: 'c', ma: 1, mi: 5 }
    - { dev: "random",  mo: "666", t: 'c', ma: 1, mi: 8 }
    - { dev: "urandom", mo: "666", t: 'c', ma: 1, mi: 9 }
    - { dev: "console", mo: "600", t: 'c', ma: 5, mi: 1 }
    - { dev: "ptmx",    mo: "666", t: 'c', ma: 5, mi: 2 }
    - { dev: "tty",     mo: "666", t: 'c', ma: 5, mi: 0 }
#  creates: "{{ osimage_path }}/dev/{null,zero,random,urandom,console,ptmx,tty}"

- name: Copy local yum.conf
  copy:
    src: "/etc/yum.conf"
    dest: "{{ osimage_path }}/etc/"

#- name: Copy gpg keys
#  copy:
#    src: "/etc/pki/rpm-gpg"
#    dest: "{{ osimage_path }}/etc/pki/"

- name: Copy yum.conf for chrooted env
  copy:
    src: "{{ osimage_path }}/etc/yum.conf"
    dest: "{{ osimage_path }}/etc/yum-chroot.conf"
    force: no

- name: Patch yum-chroot.conf
  lineinfile:
    dest: "{{ osimage_path }}/etc/yum-chroot.conf"
    line: "installroot={{ osimage_path }}"

- name: Install Centos group @Base
  yum:
    conf_file: "{{ osimage_path }}/etc/yum-chroot.conf"
    name: "@Base"
    state: installed
    disable_gpg_check: yes

- name: Register new image
  add_host:
    name: '{{ osimage_path }}'
    groups: "default-osimage"
    ansible_connection: chroot
