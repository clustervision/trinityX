---
# tasks file for firewalld

- name: Install firewalld packages
  yum:
    name: '{{ item }}'
    state: present
  with_items: '{{ firewalld_packages }}'
  tags: firewalld

- name: Enable firewalld service
  service:
    name: firewalld
    enabled: yes
  tags: firewalld

- name: Start firewalld service
  service:
    name: firewalld
    state: restarted
  tags: firewalld

- name: Assigne interfaces to the public zone
  firewalld:
    zone: public
    interface: '{{ item }}'
    state: enabled
    permanent: true
    immediate: true
  with_items: '{{ firewalld_public_interfaces }}'
  tags: firewalld

- name: Update ifcfg files for interfaces '{{ firewalld_public_interfaces }}'
  lineinfile:
    path: '/etc/sysconfig/network-scripts/ifcfg-{{ item }}'
    regexp: '^ZONE='
    line: 'ZONE=public'
  with_items: '{{ firewalld_public_interfaces }}'
  tags: firewalld

- name: Assigne interfaces to the trusted zone
  firewalld:
    zone: trusted
    interface: '{{ item }}'
    state: enabled
    permanent: true
    immediate: true
  with_items: '{{ firewalld_trusted_interfaces }}'
  tags: firewalld

- name: Update ifcfg files for interfaces '{{ firewalld_trusted_interfaces }}'
  lineinfile:
    path: '/etc/sysconfig/network-scripts/ifcfg-{{ item }}'
    regexp: '^ZONE='
    line: 'ZONE=trusted'
  with_items: '{{ firewalld_trusted_interfaces }}'
  tags: firewalld

- name: Disable NetworkManager for interfaces public and trusted interfaces
  lineinfile:
    path: '/etc/sysconfig/network-scripts/ifcfg-{{ item }}'
    regexp: '^NM_CONTROLLED='
    line: 'NM_CONTROLLED=no'
  with_flattened:
    - '{{ firewalld_public_interfaces }}'
    - '{{ firewalld_trusted_interfaces }}'
  tags: firewalld

- name: Enable masquerading on the public zone
  firewalld:
    zone: public
    masquerade: yes
    state: enabled
    permanent: true
    immediate: true
  tags: firewalld

- name: Configure open TCP ports on the public zone
  firewalld:
    zone: public
    port: '{{ item }}/tcp'
    state: enabled
    permanent: true
    immediate: true
  with_items: '{{ firewalld_public_tcp_ports }}'
  tags: firewalld

- name: Configure open UDP ports on the public zone
  firewalld:
    zone: public
    port: '{{ item }}/udp'
    state: enabled
    permanent: true
    immediate: true
  with_items: '{{ firewalld_public_udp_ports }}'
  tags: firewalld
