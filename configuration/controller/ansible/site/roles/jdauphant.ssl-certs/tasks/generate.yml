---
  - name: Generate CA Certificate key
    command: openssl genrsa -out {{ ssl_certs_path }}/cluster-ca.key 2048 creates={{ ssl_certs_path }}/cluster-ca.key

  - name: Generate CA Certificate
    command: openssl req -x509 -new -nodes -days 5475 -key {{ ssl_certs_path }}/cluster-ca.key -out {{ ssl_certs_path }}/cluster-ca.crt -subj "/C=NL/L=Amsterdam/O=ClusterVision BV./CN=clustervision.com" creates={{ ssl_certs_path }}/cluster-ca.crt

  - name: Generate RSA key and CSR for {{ ansible_fqdn }}
    command: openssl req -new -nodes -keyout {{ ssl_certs_privkey_path }} -newkey {{ ssl_certs_key_size }} -out {{ ssl_certs_csr_path }} -subj "{{ ssl_certs_fields }}" creates={{ ssl_certs_privkey_path }} creates={{ ssl_certs_csr_path }}

  - name: Generate SSL certificate for {{ ansible_fqdn }}
    command: openssl x509 -req -days {{ ssl_certs_days }} -in {{ ssl_certs_csr_path }} -CA {{ ssl_certs_path }}/cluster-ca.crt -CAkey {{ ssl_certs_path }}/cluster-ca.key -out {{ ssl_certs_cert_path }} -set_serial {{ ansible_fqdn | regex_replace('\S*(\d*)\S*', '\\1') }} creates={{ ssl_certs_cert_path }}
    when: ssl_certs_generate_self_signed

  - name: RSA key file ownership
    file: path={{ ssl_certs_privkey_path }} owner={{ ssl_certs_path_owner }} group={{ ssl_certs_path_group }} mode={{ ssl_certs_mode }}

  - name: CA key file ownership
    file: path={{ ssl_certs_path }}/cluster-ca.key owner={{ ssl_certs_path_owner }} group={{ ssl_certs_path_group }} mode={{ ssl_certs_mode }}

  - name: CA cert file ownership
    file: path={{ ssl_certs_path }}/cluster-ca.crt owner={{ ssl_certs_path_owner }} group={{ ssl_certs_path_group }} mode={{ ssl_certs_mode }}

  - name: CSR file ownership
    file: path={{ ssl_certs_csr_path }} owner={{ ssl_certs_path_owner }} group={{ ssl_certs_path_group }} mode={{ ssl_certs_mode }}

  - name: SSL certificate file ownership
    file: path={{ ssl_certs_cert_path }} owner={{ ssl_certs_path_owner }} group={{ ssl_certs_path_group }} mode={{ ssl_certs_mode }}
    when: ssl_certs_generate_self_signed
