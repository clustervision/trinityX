---
# tasks file for luna

- name: Acquire password for DB user (generate or use one from /etc/trinity/passwords)
  set_fact:
    luna_db_pwd: '{{ lookup("password",
                           "/etc/trinity/passwords/mysql/{{ luna_db_pwd }}.txt  
                            chars=ascii_letters,digits,hexdigits") }}'
  tags: luna

- name: Create a group for luna
  group:
    name: luna
    gid: '{{ luna_group_id }}'
    state: present
  tags: luna

- name: Create a user for luna
  user:
    name: luna
    uid: '{{ luna_user_id }}'
    home: '{{ luna_data_path }}'
    group: luna
    shell: /sbin/nologin
    system: yes
    state: present
  tags: luna

- name: Install luna packages
  yum:
    name: '{{ item }}'
    state: present
  with_items: '{{ luna_packages }}'
  tags: luna

- name: Ensure {{ luna_data_path }} exists
  file:
    path: '{{ luna_data_path }}'
    owner: luna
    group: luna
    state: directory
  when: primary == True
  tags: luna

- name: Copy tftp configuration to /etc/xinetd.d
  copy:
    src: 'tftp'
    dest: '/etc/xinetd.d/tftp'
  tags: luna

- name: Ensure /tftpboot exists
  file:
    path: '/tftpboot'
    state: directory
  tags: luna

- name: Copy luna_undionly.kpxe to /tftpboot
  copy:
    src: '/usr/share/ipxe/undionly.kpxe'
    dest: '/tftpboot/luna_undionly.kpxe'
    remote_src: True
  tags: luna

- name: Add a placeholder for luna's DNS zone file
  file:
    path: '{{ trix_local }}/etc/named.luna.zones'
    state: touch
  when: primary == True
  tags: luna

- name: Include luna's DNS zone file in named conf
  lineinfile:
    path: '/etc/named.conf'
    line: 'include "{{ trix_local }}/etc/named.luna.zones";'
  tags: luna

- name: Add luna's server configuration to nginx
  template:
    src: 'nginx-luna.conf'
    dest: '/etc/nginx/conf.d/nginx-luna.conf'
    backup: no
  tags: luna

- name: Copy /etc/dhcp to {{ trix_local }}/etc/dhcp
  command: cp -rafT /etc/dhcp {{ trix_local }}/etc/dhcp
  ignore_errors: yes
  when: >
    primary == True
    and ha == True
  tags: luna

- name: Delete default /etc/dhcp
  file:
    path: /etc/dhcp
    state: absent
  when: ha == True
  tags: luna

- name: replace /etc/dhcp with symlink to {{ trix_local }}/etc/dhcp
  file:
    src: '{{ trix_local }}/etc/dhcp'
    dest: /etc/dhcp
    state: link
    force: yes
  when: ha == True
  tags: luna

- name: Create a user for luna in mongodb
  command: "mongo -u root -p {{ mongo_root_pwd }} --authenticationDatabase admin --eval \"try { db.updateUser('luna', { pwd: '{{ luna_db_pwd }}', roles: [ { role: 'dbOwner', db: 'luna' } ]}) } catch(err) { db.createUser({ user: 'luna', pwd: '{{ luna_db_pwd }}', roles: [ { role: 'dbOwner', db: 'luna' } ]}) }\" luna"
  when: primary == True
  tags: luna

- name: Render /etc/luna.conf
  template:
    src: 'luna.conf'
    dest: '/etc/luna.conf'
    owner: luna
    group: luna
    mode: 0600
    backup: yes
  tags: luna
    
- name: Enable luna services
  service:
    name: '{{ item }}'
    enabled: yes
  when: ha == False
  with_items:
    - xinetd
    - dhcpd
    - lweb
    - ltorrent
  tags: luna

- name: Start luna services
  service:
    name: '{{ item }}'
    state: restarted
  when: primary == True
  with_items:
    - xinetd
    - dhcpd
    - lweb
    - ltorrent
  tags: luna

- name: Restart nginx service
  service:
    name: nginx
    state: restarted
  when: primary == True
  tags: luna

- name: Add dependency pacemaker resources
  pcs_resource:
    name: '{{ item }}'
    resource_class: 'systemd'
    resource_type: 'systemd:{{ item }}'
    options: 'op monitor interval=0 --group Trinity-stack'
    state: present
  when: primary == True and ha == True
  with_items:
    - xinetd
    - dhcpd
  tags:
    - luna
    - pcs

- name: Add luna pacemaker resources
  pcs_resource:
    name: '{{ item }}'
    resource_class: 'systemd'
    resource_type: 'systemd:{{ item }}'
    options: 'op monitor interval=0 op start timeout=120 --group Trinity-stack'
    state: present
  when: primary == True and ha == True
  with_items:
    - lweb
    - ltorrent
  tags:
    - luna
    - pcs
