---
# tasks file for bind

- name: Install bind packages
  yum:
    name: '{{ item }}'
    state: present
  with_items: '{{ bind_packages }}'

- name: Ensure {{ bind_db_path }} exists
  file:
    path: '{{ bind_db_path }}'
    owner: named
    group: named
    state: directory

- name: Render /etc/named.conf
  template:
    src: "named.conf"
    dest: "/etc/named.conf"
    backup: yes
  notify: restart named

- name: Render /etc/resolv.conf
  template:
    src: "resolv.conf"
    dest: "/etc/resolv.conf"
    backup: yes

- name: Preserve resolv.conf from being overwriten
  copy:
    src: dhclient-enter-hooks
    dest: /etc/dhcp/dhclient-enter-hooks
    backup: yes

- name: Enable named service
  service:
    name: named
    enabled: yes
  when: not ha|default(False)

- block:

  - name: Copy default zones to {{ bind_db_path }}
    shell: rsync -raW /var/named/* {{ bind_db_path }}
    args:
      creates: '{{ bind_db_path }}/named.empty'

  - name: Start named service
    service:
      name: named
      state: started
  
  - name: Add pacemaker resource
    pcs_resource:
      name: 'named'
      resource_class: 'systemd'
      resource_type: 'systemd:named'
      options: 'op monitor interval=0 --group Trinity-stack'
      state: present
    tags: pcs
    when: ha | default(False)

  when: primary | default(True)
